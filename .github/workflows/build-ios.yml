name: Build iOS IPA (Native App)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ipa:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install xcodegen
        run: brew install xcodegen

      - name: Generate Xcode Project
        run: |
          cd ios
          xcodegen generate
            
      - name: Build iOS App (Without Code Signing)
        run: |
          cd ios
          
          # On compile le projet pour la plateforme iOS en mode Release.
          xcodebuild clean build \
            -project "PinterestPurifierNative.xcodeproj" \
            -scheme "PinterestPurifierNative" \
            -configuration Release \
            -sdk iphoneos \
            -arch arm64 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            BUILD_DIR="$(pwd)/build"
            
      - name: Package to IPA
        run: |
          cd ios
          
          mkdir -p Payload
          
          APP_PATH=$(find build/Release-iphoneos -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "Erreur : Fichier .app introuvable !"
            exit 1
          fi
          
          echo "Application trouv√©e : $APP_PATH"
          mv "$APP_PATH" Payload/
          
          zip -r PinterestPurifierNative.ipa Payload
          
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PinterestPurifier-iOS-Native
          path: ios/PinterestPurifierNative.ipa
          retention-days: 7
